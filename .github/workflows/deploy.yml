# Unique name for this workflow
name: Docker CL/CD Pipeline Prod

# Definition when the workflow should run
on:
  push:
    branches: [main]

# Jobs to be executed
jobs:
  changes:
    name: test changed-files
    runs-on: ubuntu-latest
    environment: Prod
    steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        since_last_remote_commit: true
        separator: ","

    - name: copy file to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: ${{ secrets.PORT }}
        source: ${{ steps.changed-files.outputs.all_changed_files }}
        target: /home/botcongo/freqtrade
  
  deploy-to-botcognos:
    needs: build-and-push-to-prod
    runs-on: ubuntu-latest
    environment: prod

      - name: server-actions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: 22
          script: |
            echo "Update nginx-prod.conf"
            cd /home/botcogno/freqtrade/nginx
            cp nginx-prod.conf /etc/nginx/conf.d
            echo "Docker compose down"
            docker compose -f docker-compose-prod.yml down
            echo "Docker compose up"
            docker compose -f docker-compose-prod.yml up --wait
            docker rmi $(docker images --filter "dangling=true" -q --no-trunc)
